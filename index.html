<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Application</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
        }
        pre {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.95em;
            border: 1px solid #bdc3c7;
        }
        .file-list {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #eaf2f8;
            border-radius: 4px;
            border-left: 5px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-list a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        .file-list a:hover {
            text-decoration: underline;
        }
        .download-btn {
            background-color: #2ecc71;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.85em;
        }
        .download-btn:hover {
            background-color: #27ae60;
        }
        .code-snippet {
            margin-top: 25px;
            background-color: #fdfefe;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
        }
        .code-snippet code {
            font-family: 'Courier New', Courier, monospace;
            display: block;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Analysis Dashboard</h1>

        <section>
            <h2>About This Application</h2>
            <p>This application demonstrates a Python script that processes sales data, calculates key metrics, and makes the results available. The entire process is automated using GitHub Actions, ensuring analysis is run and results are published reliably.</p>
        </section>

        <section class="code-snippet">
            <h2>Python Script (execute.py)</h2>
            <p>The core logic resides in <code>execute.py</code>. It reads data, computes revenue, and extracts insights.</p>
            <p>Key functionalities include:</p>
            <ul>
                <li>Calculating total revenue per product.</li>
                <li>Determining the number of distinct regions.</li>
                <li>Identifying the top N products by revenue.</li>
                <li>Computing the 7-day rolling average revenue per region.</li>
            </ul>
            <p>A non-trivial bug related to column naming was identified and fixed in the script.</p>
            <pre><code>import json
import pandas as pd

def main():
    # Read the data
    # df = pd.read_excel("data.xlsx")
    df = pd.read_csv("data.csv") # Changed to read CSV for compatibility

    # Compute revenue
    df["revenue"] = df["units"] * df["price"]

    # row_count
    row_count = len(df)

    # regions: count of distinct regions
    regions_count = df["region"].nunique()

    # top_n_products_by_revenue (n=3)
    n = 3
    top_products = (
        df.groupby("product")["revenue"]
        .sum()
        .sort_values(ascending=False)
        .head(n)
        .reset_index()
    )
    top_products_list = [
        {"product": row["product"], "revenue": float(row["revenue"]) } 
        for _, row in top_products.iterrows()
    ]

    # rolling_7d_revenue_by_region: for each region, last value of 7-day moving average of daily revenue
    df["date"] = pd.to_datetime(df["date"])
    daily_rev = (
        df.groupby(["region", "date"])["revenue"]  # daily revenue per region - corrected typo
        .sum()
        .reset_index(name="daily_revenue") # Added name for clarity
    )

    # Compute 7-day rolling mean of revenue per region, retaining the region column
    # Ensuring 'daily_rev' is sorted by region and date before applying rolling group
    daily_rev_sorted = daily_rev.sort_values(by=['region', 'date'])
    rolling = (
        daily_rev_sorted.groupby("region")
        .apply(lambda g: g.set_index("date")["daily_revenue"].rolling("7D").mean(), include_groups=False)
        .reset_index(name="rolling_7d_revenue")
    )

    # Get the last value of the rolling average for each region
    last_rolling = (
        rolling.sort_values(["region", "date"])  # ensure order
        .groupby("region")
        .tail(1)
    )

    rolling_summary = {
        row["region"]: float(row["rolling_7d_revenue"]) if pd.notna(row["rolling_7d_revenue"]) else 0.0 
        for _, row in last_rolling.iterrows()
    }

    result = {
        "row_count": int(row_count),
        "regions": int(regions_count),
        "top_n_products_by_revenue": top_products_list,
        "rolling_7d_revenue_by_region": rolling_summary,
    }

    # Output result to result.json (which will be published by CI)
    print(json.dumps(result, indent=2))

if __name__ == "__main__":
    main()
</code></pre>
        </section>

        <section>
            <h2>Attached Files</h2>
            <ul class="file-list">
                <li>
                    <span>execute.py: The Python script for data analysis.</span>
                    <a href="execute.py" download class="download-btn">Download</a>
                </li>
                <li>
                    <span>data.csv: The input data converted from data.xlsx.</span>
                    <a href="data.csv" download class="download-btn">Download</a>
                </li>
                <li>
                    <span>
                        .github/workflows/ci.yml: GitHub Actions workflow definition.
                    </span>
                    <a href=".github/workflows/ci.yml" download class="download-btn">Download</a>
                </li>
            </ul>
        </section>

        <section class="code-snippet">
            <h2>GitHub Actions Workflow (.github/workflows/ci.yml)</h2>
            <p>This workflow automates code quality checks (Ruff linting), runs the Python script, and deploys the results to GitHub Pages.</p>
            <pre><code>name: CI and Deploy to Pages

on:
  push:
    branches: [ main ] # Trigger on push to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Specify Python version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas ruff
          # If execute.py requires other specific libraries, add them here

      - name: Lint with Ruff
        run: ruff check .

      - name: Run data processing script
        # Ensure data.csv is available in the working directory
        run: python execute.py > result.json

      - name: Upload result.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: result-json
          path: result.json

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-artifact
          path: ./${{ github.event.repository.name }} # Changed to refer to repo name for clarity
          # Note: Depending on the repo structure, you might need to adjust this path.
          # For a simple structure, this might just be './' or './docs'
          # If you deploy to a specific subfolder, adjust accordingly.

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # This step implicitly uses the artifact uploaded by 'Upload artifact for deployment'
        # Ensure your repo settings are configured for GitHub Pages deployment (e.g., from 'gh-pages' branch or 'docs/' folder)
</code></pre>
        </section>
    </div>

    <script>
        // JavaScript can be added here for interactivity if needed.
        // For this demonstration, the application is primarily static HTML.
    </script>
</body>
</html>
